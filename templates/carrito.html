{% extends "base.html" %}

{% block content %}
<h2 style="text-align:center; margin-top:20px;">üõí Tu Carrito</h2>

{% if carrito|length == 0 %}
    <p style="text-align:center; font-size:18px; margin-top:40px;">
        Tu carrito est√° vac√≠o üõçÔ∏è
    </p>
{% else %}

<div class="carrito-container">

    <!-- LISTA DE PRODUCTOS -->
    <div class="carrito-items">
        {% for item in carrito %}
        <div class="carrito-card">
            <img src="{{ url_for('static', filename='img/' ~ item['imagen']) }}" alt="{{ item['nombre'] }}">
            <div class="carrito-info">
                <h3>{{ item['nombre'] }}</h3>
                <p>Precio: ${{ item['precio'] }}</p>
                <p>Subtotal: ${{ item['precio'] * item['cantidad'] }}</p>
                <div class="cantidad-control">
                    <button class="btn-cantidad" onclick="cambiarCantidad('{{ item.id }}', 'restar')">-</button>
                    <span>{{ item.cantidad }}</span>
                    <button class="btn-cantidad" onclick="cambiarCantidad('{{ item.id }}', 'sumar')">+</button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- RESUMEN DE COMPRA Y BOT√ìN FINALIZAR -->
    <div class="carrito-resumen">
        <h3>Resumen</h3>
        <div class="resumen-linea">
            <span>Subtotal:</span>
            <span>${{ subtotal }}</span>
        </div>
        <div class="resumen-linea">
            <span>Env√≠o:</span>
            {% if envio == 0 %}
                <span class="total-gratis">GRATIS</span>
            {% else %}
                <span>${{ envio }}</span>
            {% endif %}
        </div>
        <hr style="margin: 15px 0;">
        <div class="resumen-linea" style="font-size:20px; font-weight:bold;">
            <span>Total:</span>
            <span>${{ total }}</span>
        </div>

        <!-- BOT√ìN FINALIZAR CON reCAPTCHA -->
        <form id="carrito-form">
            <input type="hidden" id="recaptcha_token" name="recaptcha_token">
            <button type="submit" id="finalizar-compra" class="boton-finalizar">Finalizar compra</button>
        </form>

        <!-- PAYPAL OCULTO -->
        <div id="paypal-button-container" style="margin-top: 20px; display:none;"></div>

        <!-- BOT√ìN VAC√çAR -->
        <a class="boton-vaciar" href="{{ url_for('vaciar_carrito') }}" id="vaciar-carrito">Vaciar carrito</a>
    </div>

</div>

<!-- SDK de PayPal -->
<script src="https://www.paypal.com/sdk/js?client-id=AQZ3sbZL1Dgp-LE1oLQEvRl2E6nqnoijCZ1Z6ngGFdXQY-45CBH6dIzYmHE_3Y9tX47wz9Q_CAvEQdb5&currency=MXN"></script>

<!-- reCAPTCHA v3 -->
<script src="https://www.google.com/recaptcha/api.js?render=6LfgThQsAAAAAKBIskJdPoTp_e9DeehR4fWAOZQc"></script>

<script>
function cambiarCantidad(id, accion) {
    fetch(`/actualizar_cantidad/${id}/${accion}`).then(() => location.reload());
}

// Validar reCAPTCHA antes de mostrar PayPal
document.getElementById('carrito-form').addEventListener('submit', function(e) {
    e.preventDefault();
    grecaptcha.ready(function() {
        grecaptcha.execute('6LfgThQsAAAAAKBIskJdPoTp_e9DeehR4fWAOZQc', {action: 'finalizar_compra'}).then(function(token) {
            document.getElementById('recaptcha_token').value = token;

            // Ocultar botones del carrito
            document.querySelectorAll('.btn-cantidad').forEach(btn => btn.style.display = 'none');
            document.getElementById('vaciar-carrito').style.display = 'none';
            document.getElementById('finalizar-compra').style.display = 'none';

            // Mostrar PayPal
            document.getElementById('paypal-button-container').style.display = 'block';
        });
    });
});

// Configuraci√≥n de PayPal
paypal.Buttons({
    createOrder: function(data, actions) {
        return actions.order.create({
            purchase_units: [{ amount: { value: '{{ total }}' } }]
        });
    },
    onApprove: function(data, actions) {
        return actions.order.capture().then(function(detalles) {
            fetch("/pago_completado", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ detalles: detalles })
            }).then(() => {
                alert("Pago realizado con √©xito");
                window.location.href = "/gracias";
            });
        });
    },
    onCancel: function(data) {
        alert("El pago fue cancelado");
    },
    onError: function(err) {
        console.error(err);
        alert("Ocurri√≥ un error en el pago, intenta nuevamente.");
    }
}).render('#paypal-button-container');
</script>

{% endif %}
{% endblock %}
